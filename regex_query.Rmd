---
title: "Analysis of Regex on So"
author: "Miles McBain"
date: "2018-04-21"
output: html_document
---

```{r }
library(stackr)
library(tidyverse)
library(tidytext)
library(lubridate)
regex_faq <- read_rds("./data/all_faqs.Rds")

coocurring_tags <-
  regex_faq %>%
  select(tags) %>%
  unnest_tokens(tag, tags) %>%
  filter(tag != "regex")

tag_counts <-
  coocurring_tags %>%
  count(tag, sort = TRUE)

print(tag_counts, n = 300)

names(regex_faq)
```

# observations:
R is the 15th most commonly coocurring tag. The tags do not give much insight since they mostly refer to programming environments. Although we do see some concepts ranked highly:

```{r}
 regex_concepts <-
   c("replace",
   "match",
   "parsing", 
   "validation",
   "split",
   "rewrite",
   "negation",
   "escaping",
   "search",
   "greedy",
   "lookarounds",
   "substring",
   "whitespace")

 tag_counts %>%
      filter(tag %in% regex_concepts) %>%
      ggplot(aes(x = fct_reorder(tag,n), y = n)) +
        geom_col()
```

## Weighted tag analysis
A linear model might be an interesting way to model the concept importance:

```{r}
tags_id_view_list <-
  regex_faq %>%
  select(question_id, view_count, tags) %>%
  unnest_tokens(tag, tags) %>%
  mutate(count = 1) 

concept_tags_dtm <-
  tags_id_view_list %>%
  filter(tag %in% regex_concepts) %>%
  cast_dtm(question_id, tag, count) %>%
  as.matrix()

tidy_concept_tags <- 
  tidy(concept_tags_dtm) %>%
  rename(question_id = .rownames) %>%
  mutate(question_id = as.integer(question_id))

regex_faq %>%
  select(view_count, question_id) %>%
  left_join(tidy_concept_tags) %>%
  mutate_all(.funs = funs(replace_na), 0) %>%
  select(-question_id) %>%
  lm(view_count ~ ., .) %>%
  summary()
```
### Observations
R^2 is rubbish but model does indicate some tags are associated with higher counts. It would be interesting to try a model with all tags.

## Model popular tags + concepts
Here I try a concept tag model controlling for popular framework tags and question age.

```{r}
faq_views_days <- 
  regex_faq %>%
  select(question_id, view_count, creation_date) %>%
  mutate(days_since_creation = interval(creation_date,
                                        ymd_hms("2018-04-21 12:00:00")) / days(1)) %>%
  select(-creation_date)

popular_tags <-
  tag_counts$tag[1:30]

tidy_populr_concept_tags <-
  tags_id_view_list %>%
  filter(tag %in% union(regex_concepts, popular_tags)) %>%
  cast_dtm(question_id, tag, count) %>%
  as.matrix() %>%
  tidy() %>%
  rename(question_id = .rownames) %>%
  mutate(question_id = as.integer(question_id))

tag_model <- 
  faq_views_days %>%
  left_join(tidy_populr_concept_tags) %>%
  mutate_all(.funs = funs(replace_na), 0) %>%
  mutate(match = as.integer(match | matching)) %>%     #merge match columns
  select(-question_id, -matching) %>%
  lm(view_count ~ ., .)

summary(tag_model)

tidy(tag_model, conf.int = TRUE) %>%
  mutate(concept = term %in% regex_concepts) %>%
  ggplot(aes(x = estimate, y = fct_reorder(term, conf.high), colour = concept)) +
    geom_point() +
    geom_errorbarh(aes(xmin = conf.low,
                       xmax = conf.high)) +
  ggtitle("Esitmated effect of tag presence on Stack Overflow FAQ views",
          subtitle = "Controlling for popular frameworks and question age") +
  xlab("Estimated effect on views with 95% CI") +
  ylab("FAQ Tags coocurring with 'regex'")

```

### Observations
Controlling for question age and popular framework effects, there is still evidence that the following regex concept tags are associated with higher question views: negation, lookarounds, validation, greedy, and whitespace.

The signs of the framework tags are mostly negative, which seemed odd, until I realised that a specific framework tag splinters the potential viewership. It makes sense that general regular expression questions get more views within the regex tag. I also tried fitting a set of tag interactions with days since creation. This didn't change the overall story much, the same concept tags as before had strong interaction effects, suggesting they grow faster. 

The diagnostics of the model are all poor, but we know we have unobserved variables creating noise. This is not meant to be a predictive model - its use is comparing the strength if tag effects.

note: I noticed 'match' and 'matching' as separate tags, and so I decided to merge the tags.

## Regex + R tag pair
Here I filter down to R tags within the regex faqs to see what the other tags and titles are.

```{r}


```
# TODO
* Analysis of regex, R tag pair.
* Text analysis/topic modelling of Question content.
